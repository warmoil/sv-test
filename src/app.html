<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="%sveltekit.assets%/favicon.png"/>
    <meta name="viewport" content="width=device-width"/>
    <title>스벨트</title>
    %sveltekit.head%
</head>
<body data-sveltekit-preload-data="hover">
<!--		<h1>%sveltekit.body%</h1>-->
<style>
    table {
        width: 50%;
        border: 1px solid black;
        border-collapse: collapse;
        text-align: center;
    }
</style>
<h2 id="total-user-count">
    로딩중입니다.
</h2>
이름:<input type="text" id="name-input">
닉네임:<input type="text" id="nick-text">
<button id="create-btn">
    추가
</button>
<table border="1" id="userList">
    <th>idx</th>
    <th>name</th>
    <th>nickName</th>
    <tbody id="tBody">
    </tbody>
</table>
<button id="go-first-page">처음으로</button>
<button id="go-last-page">끝으로</button>
<div id="page-div"></div>
<input type="hidden" id="current-page" value=1>
<button id="issue-btn">이슈 제보</button>
<script>
    const tBody = document.getElementById('tBody')
    const baseUrl = '/user'
    const pageDiv = document.getElementById('page-div')
    const totalUserCountDiv = document.getElementById('total-user-count')
    const currentPage = document.getElementById('current-page')
    const nameInput = document.getElementById('name-input')
    const nickNameInput = document.getElementById('nick-text')
    const issueBtn = document.getElementById('issue-btn');
    let lastPage

    const issueReportAction = () =>{
        const issue = prompt('이슈를 적어주세요 ');
        if(issue) alert('구현이 귀찮습니다');
        else alert('언제든지 제보해주세요!')
    }


    async function getList(page) {
        let url = baseUrl
        if (page) {
            url += `?page=${page}`
        }
        await fetch(url).then(res => res.json())
            .then(json => {
                // const json = json
                tBody.innerHTML = ''
                json.results.forEach(j => {
                    tBody.innerHTML += `
                            <tr>
                            <td>${j.idx}</td>
                            <td>${j.name}</td>
                            <td>${j.nickName}</td>
                            </tr>
                        `;
                });
                totalUserCountDiv.innerHTML = '총 ' + json.totalCount + '명'
                currentPage.value = json.currentPage + 1
                pageDiv.innerHTML = ``;
                lastPage = json.totalPage
                const totalPage = json.totalPage
                if (totalPage > 1) {
                    for (let i = 1; i <= totalPage; i++) {
                        pageDiv.innerHTML += `
                            <button ${i === Number(currentPage.value) ? 'disabled style="color: red"' : ''}  onclick="getList(${i})">${i}</button>
                        `
                    }
                }
                nameInput.focus()
            }).catch(e=>{
                console.log(e)
                totalUserCountDiv.innerHTML = '로딩실패;;'
            })
    }

    function createUser() {
        console.log(document.getElementById('name-input').value)
        fetch(baseUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                name: document.getElementById('name-input').value.replaceAll(' ',''),
                nickName: document.getElementById('nick-text').value.replaceAll(' ',''),
            })
        }).then(res => {
            if (res.status === 200 || res.status === 201) {
                console.log(res)
                getList(currentPage.value)
                nameInput.value = ''
                nickNameInput.value = ''
                nameInput.focus()
            } else if (res.status === 409) {
                throw new Error('이미 존재하는 닉네임 입니다.');
            } else {
                console.log(res)
                throw new Error('알수없는 에러')
            }
        })
            .catch(e => {
                alert(e)
            })
    }


    document.addEventListener('DOMContentLoaded', () => {
        nameInput.focus()
        getList()
        document.body.addEventListener('keypress', e => {
            if (e.key === 'Enter') createUser()
        })
        issueBtn.addEventListener('click',()=>{
            issueReportAction();
        })
        document.getElementById('go-first-page').addEventListener('click', () => {
            getList()
        })
        document.getElementById('go-last-page').addEventListener('click', () => {
            getList(lastPage)
        })
        document.getElementById('create-btn').addEventListener('click', () => {
            createUser()
        })
    })
</script>
</body>
</html>
